<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="CozyDash" />
    
    <title>Cozy Dashboard</title>
    
    <style>
        /* CSS Reset & Legacy Fixes */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: #f0e8de;
            color: #5c5042;
            padding: 10px;
            /* Prevent rubber-banding on iOS */
            height: 100vh;
            overflow-y: scroll; 
            -webkit-overflow-scrolling: touch;
        }

        .grid {
            max-width: 768px;
            margin: 0 auto;
        }

        .card {
            background: #fffcf9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #efe6dc;
            text-align: center;
            position: relative;
            display: block; /* Ensure block level for old webkit */
        }

        .title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            color: #9c8c74;
            margin-bottom: 8px;
            margin-top: 0;
        }

        /* Weather Section */
        #clock { font-size: 36px; font-weight: 300; color: #558b76; margin-bottom: 5px; }
        #date { font-size: 16px; color: #8c7b66; margin-bottom: 10px; }
        
        .weather-row {
            width: 100%;
            display: table; /* Fallback for no-flexbox */
            margin-top: 10px;
        }
        .w-col {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
        }
        .large-temp { font-size: 48px; color: #333; font-weight: bold;}
        .condition-icon { font-size: 40px; }
        
        /* Flexbox hacks for iPad 2 */
        .flex-container {
            display: -webkit-box;      /* OLD - iOS 6-, Safari 3.1-6 */
            display: -moz-box;         /* OLD - Firefox 19- (buggy but mostly works) */
            display: -ms-flexbox;      /* TWEENER - IE 10 */
            display: -webkit-flex;     /* NEW - Chrome */
            display: flex;             /* NEW, Spec - Opera 12.1, Firefox 20+ */
            
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            -webkit-justify-content: space-between;
            justify-content: space-between;
        }
        
        .half-card {
            width: 48%;
            margin-bottom: 12px;
        }

        /* Content Typography */
        .content-text { font-size: 15px; line-height: 1.4; color: #4a4036; }
        .sub-text { font-size: 12px; color: #999; margin-top: 5px; font-style: italic; }

        /* Images */
        #dailyImage {
            width: 100%;
            height: 160px;
            background-color: #ddd; /* Placeholder color */
            object-fit: cover;
            border-radius: 8px;
            display: block;
        }

        /* News List */
        ul#headlines { list-style: none; padding: 0; margin: 0; text-align: left; }
        ul#headlines li { 
            padding: 8px 0; 
            border-bottom: 1px solid #f0e6dc; 
            font-size: 14px;
        }
        ul#headlines a { text-decoration: none; color: #333; }

        /* Gear Button */
        .gear-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 18px;
            opacity: 0.3;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="grid">
        
        <div class="card" id="weatherCard">
            <div class="gear-btn" onclick="askLocation()">‚öôÔ∏è</div>
            <div id="date">Loading...</div>
            <div id="clock">00:00</div>
            
            <div class="weather-row">
                <div class="w-col" style="width: 30%">
                    <div class="condition-icon" id="weatherIcon">üå§Ô∏è</div>
                </div>
                <div class="w-col" style="width: 40%">
                    <div class="large-temp" id="currentTemp">--¬∞</div>
                </div>
                <div class="w-col" style="width: 30%; text-align: left; padding-left: 10px;">
                    <div id="minMaxTemp" style="font-size: 14px; font-weight:bold;">-- / --</div>
                    <div id="moonPhase" style="font-size: 12px; margin-top: 4px; color: #777;">Moon: --</div>
                </div>
            </div>
            <div id="weatherError" style="font-size: 10px; color: #cc5555; margin-top: 5px; display:none;">
                Weather Data Offline (SSL Error)
            </div>
        </div>

        <div class="card">
            <div class="title">Headlines</div>
            <ul id="headlines"><li>Loading...</li></ul>
        </div>

        <div class="flex-container">
            
            <div class="card half-card">
                <div class="title">Suggested Activity</div>
                <div class="content-text" id="activity">...</div>
            </div>

            <div class="card half-card">
                <div class="title">Moon Phase</div>
                <div class="content-text" id="moonText">...</div>
                <div class="sub-text" id="moonIcon" style="font-size: 24px;">üåë</div>
            </div>

            <div class="card half-card">
                <div class="title">Random Fact</div>
                <div class="content-text" id="fact">...</div>
            </div>

            <div class="card half-card">
                <div class="title">Daily Vibe</div>
                <div class="content-text" id="horoscope">...</div>
            </div>

            <div class="card" style="width: 100%; padding: 5px;">
                <img id="dailyImage" src="" />
                <div class="title" style="margin-top: 5px;">Daily View</div>
            </div>
            
            <div class="card" style="width: 100%;">
                <div class="title">Quote</div>
                <div class="content-text" id="quote">...</div>
                <div class="sub-text" id="quoteAuthor"></div>
            </div>

        </div>
    </div>

    <script>
        // --- DATA SETS (Local data to bypass API failures) ---
        var FACTS = [
            "Honey never spoils.", "Octopuses have three hearts.", "Bananas are berries.",
            "Wombat poop is cube-shaped.", "The Eiffel Tower can be 15 cm taller in summer.",
            "Venus is the only planet to spin clockwise.", "Nutmeg is a hallucinogen.",
            "A cloud can weigh more than a million pounds.", "A bolt of lightning contains enough energy to toast 100,000 slices of bread."
        ];

        var ACTIVITIES = [
            "Read a book chapter", "Water the plants", "Do a 10 min stretch",
            "Listen to a classic album", "Write a journal entry", "Organize one drawer",
            "Make herbal tea", "Watch a documentary", "Call a relative"
        ];

        var VIBES = [
            "Take it easy today.", "Focus on the good.", "You are enough.",
            "Small steps count.", "Breathe deeply.", "Trust the process.",
            "Creativity is flowing.", "Rest is productive.", "Be kind to you."
        ];

        // --- LOCATION ---
        var LAT = localStorage.getItem('LAT') || 40.71;
        var LON = localStorage.getItem('LON') || -74.00;

        function askLocation() {
            var l = prompt("Enter Lat,Lon (e.g. 40.71,-74.00)", LAT + "," + LON);
            if(l && l.indexOf(',') > -1) {
                var parts = l.split(',');
                LAT = parseFloat(parts[0]);
                LON = parseFloat(parts[1]);
                localStorage.setItem('LAT', LAT);
                localStorage.setItem('LON', LON);
                updateAll();
            }
        }

        // --- HELPER: Moon Phase Calculator (No API) ---
        function getMoonPhase() {
            var d = new Date();
            var year = d.getFullYear();
            var month = d.getMonth() + 1;
            var day = d.getDate();
            
            var c = e = j = 0;
            if (month < 3) { year--; month += 12; }
            ++month;
            c = 365.25 * year;
            e = 30.6 * month;
            j = c + e + day - 694039.09; // jd is total days elapsed
            j /= 29.53058; // divide by the moon cycle
            var b = parseInt(j); // int(j)
            j -= b; // leave the fractional part of j
            b = Math.round(j * 8); // scale fraction from 0-8
            if (b >= 8) b = 0; // 0 and 8 are the same
            
            var phases = {
                0: ["New Moon", "üåë"], 1: ["Waxing Crescent", "üåí"], 2: ["First Quarter", "üåì"],
                3: ["Waxing Gibbous", "üåî"], 4: ["Full Moon", "üåï"], 5: ["Waning Gibbous", "üåñ"],
                6: ["Last Quarter", "üåó"], 7: ["Waning Crescent", "üåò"]
            };
            return phases[b];
        }

        // --- HELPER: AJAX Request ---
        function fetchJSON(url, callback, failCallback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.timeout = 5000; // 5 second timeout
            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 400) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        callback(data);
                    } catch (e) { if(failCallback) failCallback(); }
                } else { if(failCallback) failCallback(); }
            };
            xhr.onerror = function() { if(failCallback) failCallback(); };
            xhr.ontimeout = function() { if(failCallback) failCallback(); };
            xhr.send();
        }

        // --- FUNCTIONS ---

        function updateClock() {
            var now = new Date();
            var h = now.getHours();
            var m = now.getMinutes();
            var ampm = h >= 12 ? 'pm' : 'am';
            h = h % 12;
            h = h ? h : 12; // the hour '0' should be '12'
            m = m < 10 ? '0'+m : m;
            
            var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            
            document.getElementById('clock').innerHTML = h + ":" + m + "<span style='font-size:16px'>" + ampm + "</span>";
            document.getElementById('date').innerHTML = days[now.getDay()] + ", " + months[now.getMonth()] + " " + now.getDate();
        }

        function updateWeather() {
            // Using Open-Meteo. If this fails on iPad 2, the "weatherError" div will show.
            var url = "https://api.open-meteo.com/v1/forecast?latitude=" + LAT + "&longitude=" + LON + "&current_weather=true&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto";
            
            fetchJSON(url, function(data) {
                var w = data.current_weather;
                var daily = data.daily;
                
                document.getElementById('currentTemp').innerHTML = Math.round(w.temperature) + "¬∞";
                document.getElementById('minMaxTemp').innerHTML = Math.round(daily.temperature_2m_min[0]) + "¬∞ / " + Math.round(daily.temperature_2m_max[0]) + "¬∞";
                document.getElementById('weatherError').style.display = "none";
                
                // Simple Icon Logic
                var code = w.weathercode;
                var icon = "‚òÅÔ∏è";
                if(code < 2) icon = "‚òÄÔ∏è";
                else if(code < 4) icon = "‚õÖ";
                else if(code < 60) icon = "üå´Ô∏è";
                else if(code < 80) icon = "üåßÔ∏è";
                else if(code < 90) icon = "‚õàÔ∏è";
                else icon = "üå®Ô∏è";
                document.getElementById('weatherIcon').innerHTML = icon;

            }, function() {
                // If weather fails (CORS/SSL), show error
                document.getElementById('weatherError').style.display = "block";
                document.getElementById('currentTemp').innerHTML = "--";
            });
        }

        function updateStaticContent() {
            // Local Activity
            var act = ACTIVITIES[Math.floor(Math.random() * ACTIVITIES.length)];
            document.getElementById('activity').innerHTML = act;

            // Local Fact
            var fact = FACTS[Math.floor(Math.random() * FACTS.length)];
            document.getElementById('fact').innerHTML = fact;

            // Local Vibe
            var vibe = VIBES[Math.floor(Math.random() * VIBES.length)];
            document.getElementById('horoscope').innerHTML = vibe;

            // Moon Phase (Calculated)
            var moon = getMoonPhase();
            document.getElementById('moonText').innerHTML = moon[0];
            document.getElementById('moonIcon').innerHTML = moon[1];
            document.getElementById('moonPhase').innerHTML = "Moon: " + moon[1];
            
            // Image - Switching to Picsum which is usually more reliable on old SSL
            var rand = Math.floor(Math.random() * 100);
            document.getElementById('dailyImage').src = "https://picsum.photos/600/300?grayscale&random=" + rand;
        }

        function updateNews() {
            // Using RSS2JSON which you confirmed works
            var feed = "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml";
            var url = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(feed);
            
            fetchJSON(url, function(data) {
                var list = document.getElementById('headlines');
                list.innerHTML = "";
                for(var i=0; i<4; i++) {
                    if(data.items[i]) {
                        var item = data.items[i];
                        var li = document.createElement('li');
                        li.innerHTML = "<a href='" + item.link + "'>" + item.title + "</a>";
                        list.appendChild(li);
                    }
                }
            });
        }

        function updateQuote() {
            fetchJSON('https://dummyjson.com/quotes/random', function(data) {
                document.getElementById('quote').innerHTML = '"' + data.quote + '"';
                document.getElementById('quoteAuthor').innerHTML = "- " + data.author;
            }, function() {
                document.getElementById('quote').innerHTML = '"Stay Cozy."';
            });
        }

        function init() {
            updateClock();
            updateWeather();
            updateStaticContent();
            updateNews();
            updateQuote();
        }

        // --- RUN ---
        init();
        
        // Timers
        setInterval(updateClock, 1000); // Clock every second
        setInterval(init, 1800000); // Refresh data every 30 mins

    </script>
</body>
</html>
