<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="format-detection" content="telephone=no" />
    
    <title>Cozy Dashboard</title>
    
    <style>
        /* CSS Cleanups for older WebKit */
        body {
            margin: 0;
            font-family: -apple-system, Helvetica, Arial, sans-serif;
            background: #f0e8de;
            color: #5c5042;
            display: -webkit-flex; /* Old WebKit prefix */
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-align-items: center;
            align-items: center;
            padding: 10px;
            min-height: 100vh;
            /* Prevent text selection to make it feel like an App */
            -webkit-user-select: none; 
            user-select: none;
            -webkit-touch-callout: none;
        }

        .grid {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            width: 100%;
            max-width: 768px; /* Optimized for iPad width */
            padding-top: 20px;
        }

        .card {
            background: #fffcf9; /* Removed gradient for performance on old GPU */
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 1px solid #efe6dc;
            text-align: center;
            position: relative;
        }

        .gear {
            position: absolute;
            top: 10px;
            right: 12px;
            font-size: 20px;
            opacity: 0.5;
            cursor: pointer;
        }

        .title {
            font-size: 14px;
            text-transform: uppercase;
            font-weight: bold;
            color: #9c8c74;
            margin-bottom: 8px;
        }

        /* Clock */
        #clock {
            font-size: 40px;
            font-weight: bold;
            color: #558b76;
        }
        #date {
            font-size: 18px;
            color: #8c7b66;
        }

        /* Weather Layout */
        .weather-row {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-around;
            justify-content: space-around;
            -webkit-align-items: center;
            align-items: center;
            margin: 10px 0;
        }
        .large-temp { font-size: 50px; color: #333; }
        .condition-icon { font-size: 45px; }

        /* Precip Graph */
        .precip-grid {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: flex-end;
            align-items: flex-end;
            height: 50px;
            margin-top: 15px;
            border-bottom: 1px solid #ddd;
        }
        .precip-item {
            -webkit-flex: 1;
            flex: 1;
            text-align: center;
        }
        .precip-bar {
            width: 80%;
            margin: 0 auto;
            background: #a4c5e0;
            min-height: 2px;
        }
        .precip-hour {
            font-size: 9px;
            color: #999;
            margin-top: 2px;
        }

        /* Headlines */
        #newsCard ul { list-style: none; padding: 0; margin: 0; text-align: left; }
        #newsCard li { padding: 8px 0; border-bottom: 1px solid #eee; }
        #newsCard a { text-decoration: none; color: #444; font-size: 14px; display: block;}

        /* Grid for smaller cards */
        .half-grid {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            -webkit-justify-content: space-between;
            justify-content: space-between;
        }
        .half-card-wrapper {
            width: 48%; /* Flex-basis fallback for old flexbox */
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
        }
        
        .content-text { font-size: 16px; color: #4a4036; line-height: 1.4; }
        .sub-text { font-size: 12px; color: #999; margin-top: 5px; font-style: italic; }

        img#dailyImage {
            width: 100%;
            height: 180px;
            object-fit: cover; /* Might degrade gracefully on iPad 2 */
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <div class="grid">
        <div class="card" id="weatherCard">
            <div class="gear" onclick="showLocationPrompt()">‚öôÔ∏è</div>
            <div id="date">Loading...</div>
            <div id="clock">--:--</div>
            
            <div class="weather-row">
                <div class="condition-icon" id="weatherIcon">üå§Ô∏è</div>
                <div class="large-temp" id="currentTemp">--¬∞</div>
                <div style="text-align: left;">
                    <div id="minMaxTemp">L:-- H:--</div>
                    <div id="sunData" style="font-size: 12px; margin-top:4px;"></div>
                </div>
            </div>
            <div id="weatherInfo" style="font-size:12px; color:#aaa;"></div>
            <div class="precip-grid" id="precipContainer"></div>
        </div>

        <div class="card" id="newsCard">
            <div class="title">Top Headlines</div>
            <ul id="headlines"><li>Loading...</li></ul>
        </div>

        <div class="half-grid">
            <div class="half-card-wrapper">
                <div class="card">
                    <div class="title">ISS Location</div>
                    <div class="content-text" id="issLocation">Tracking...</div>
                </div>
                <div class="card">
                    <div class="title">Activity</div>
                    <div class="content-text" id="activity">...</div>
                </div>
                <div class="card">
                    <div class="title">Daily Vibe</div>
                    <div class="content-text" id="horoscope">...</div>
                </div>
            </div>

            <div class="half-card-wrapper">
                <div class="card">
                    <div class="title">Fact</div>
                    <div class="content-text" id="fact">...</div>
                </div>
                <div class="card">
                    <div class="title">Quote</div>
                    <div class="content-text" id="quote">...</div>
                    <div class="sub-text" id="quoteAuthor"></div>
                </div>
                <div class="card" style="padding:5px;">
                    <img id="dailyImage" src="" />
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        var ACTIVITIES = [
            "Read a chapter", "Water plants", "15m Walk", 
            "Listen to music", "Stretch", "Journaling", 
            "Tidy desk", "Cook new recipe", "Call a friend", 
            "Meditate", "Draw something", "Clean email"
        ];

        var VIBES = [
            "Focus on you.", "Creativity flows.", "Be patient.", 
            "Good surprise coming.", "Take it slow.", "Energy is high.",
            "Trust intuition.", "Be kind.", "Rest is good."
        ];

        var ICONS = { 
            0:"‚òÄÔ∏è", 1:"üå§Ô∏è", 2:"‚õÖ", 3:"‚òÅÔ∏è", 45:"üå´Ô∏è", 
            51:"üåßÔ∏è", 61:"üåßÔ∏è", 71:"‚ùÑÔ∏è", 80:"üå¶Ô∏è", 95:"‚õàÔ∏è" 
        };

        // --- 2. LEGACY AJAX HELPER (No Fetch API) ---
        function makeRequest(url, successCallback, errorCallback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 400) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        successCallback(data);
                    } catch (e) {
                        if(errorCallback) errorCallback();
                    }
                } else {
                    if(errorCallback) errorCallback();
                }
            };
            xhr.onerror = function() {
                if(errorCallback) errorCallback();
            };
            xhr.send();
        }

        // --- 3. STATE ---
        var LAT = localStorage.getItem('LAT') ? parseFloat(localStorage.getItem('LAT')) : 40.71;
        var LON = localStorage.getItem('LON') ? parseFloat(localStorage.getItem('LON')) : -74.00;

        function showLocationPrompt() {
            var lat = prompt("Latitude:", LAT);
            var lon = prompt("Longitude:", LON);
            if (lat && lon) {
                LAT = parseFloat(lat);
                LON = parseFloat(lon);
                localStorage.setItem('LAT', LAT);
                localStorage.setItem('LON', LON);
                updateAll();
            }
        }

        // --- 4. FUNCTIONS ---

        function updateClock() {
            var now = new Date();
            // iPad 2 might struggle with some locale options, keeping it simple
            var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            
            var dayName = days[now.getDay()];
            var monthName = months[now.getMonth()];
            var dateNum = now.getDate();
            
            var hours = now.getHours();
            var mins = now.getMinutes();
            var ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            mins = mins < 10 ? '0'+mins : mins;
            
            document.getElementById("date").innerHTML = dayName + ", " + monthName + " " + dateNum;
            document.getElementById("clock").innerHTML = hours + ":" + mins + " " + ampm;
        }

        function getWeather() {
            var url = "https://api.open-meteo.com/v1/forecast?latitude=" + LAT + "&longitude=" + LON + "&current_weather=true&hourly=precipitation&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&temperature_unit=fahrenheit&timezone=auto";
            
            makeRequest(url, function(data) {
                // Current
                var w = data.current_weather;
                var iconCode = w.weathercode;
                // Simple fallback for icon map
                var icon = ICONS[iconCode] ? ICONS[iconCode] : "üåà";
                
                document.getElementById("currentTemp").innerHTML = Math.round(w.temperature) + "¬∞";
                document.getElementById("weatherIcon").innerHTML = icon;
                
                // Daily
                var max = Math.round(data.daily.temperature_2m_max[0]);
                var min = Math.round(data.daily.temperature_2m_min[0]);
                // Parse time carefully for old browsers
                var sunrise = data.daily.sunrise[0].split('T')[1];
                var sunset = data.daily.sunset[0].split('T')[1];
                
                document.getElementById("minMaxTemp").innerHTML = "L:" + min + "¬∞ H:" + max + "¬∞";
                document.getElementById("sunData").innerHTML = "‚òÄÔ∏è " + sunrise + " &nbsp; üåô " + sunset;
                document.getElementById("weatherInfo").innerHTML = LAT.toFixed(2) + ", " + LON.toFixed(2);

                // Precip Graph (Simple loop)
                var currentHour = new Date().getHours();
                var precipHTML = "";
                // Grab next 6 hours
                for(var i=0; i<6; i++) {
                    var idx = currentHour + i;
                    if(idx >= 24) idx = 23; // prevention
                    var p = data.hourly.precipitation[idx];
                    var height = (p * 20); 
                    if(height > 40) height = 40;
                    if(height < 2) height = 2;
                    
                    var color = p > 0 ? "#5dade2" : "#e0e0e0";
                    
                    precipHTML += "<div class='precip-item'>" +
                        "<div class='precip-bar' style='height:" + height + "px; background:" + color + "'></div>" +
                        "<div class='precip-hour'>+" + i + "h</div>" +
                    "</div>";
                }
                document.getElementById("precipContainer").innerHTML = precipHTML;
            });
        }

        function getISS() {
            makeRequest('https://api.wheretheiss.at/v1/satellites/25544', function(data) {
                document.getElementById("issLocation").innerHTML = 
                    "Lat: " + data.latitude.toFixed(1) + "<br>Lon: " + data.longitude.toFixed(1);
            });
        }

        function getFact() {
            // Using a simpler API that returns plain text or easy JSON
            makeRequest('https://uselessfacts.jsph.pl/api/v2/facts/random?language=en', function(data) {
                document.getElementById("fact").innerHTML = data.text;
            });
        }

        function getQuote() {
            makeRequest('https://dummyjson.com/quotes/random', function(data) {
                document.getElementById("quote").innerHTML = '"' + data.quote + '"';
                document.getElementById("quoteAuthor").innerHTML = "- " + data.author;
            });
        }

        function getNews() {
            // Using a proxy to convert RSS to JSON
            var feed = encodeURIComponent("https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml");
            makeRequest("https://api.rss2json.com/v1/api.json?rss_url=" + feed, function(data) {
                var list = document.getElementById("headlines");
                list.innerHTML = "";
                // Only show 3 items
                for(var i=0; i<3; i++) {
                    if(data.items[i]) {
                        var item = data.items[i];
                        var li = document.createElement("li");
                        var a = document.createElement("a");
                        a.href = item.link;
                        a.innerHTML = item.title;
                        li.appendChild(a);
                        list.appendChild(li);
                    }
                }
            });
        }

        function getLocalContent() {
            var rAct = ACTIVITIES[Math.floor(Math.random() * ACTIVITIES.length)];
            document.getElementById("activity").innerHTML = rAct;

            var rVibe = VIBES[Math.floor(Math.random() * VIBES.length)];
            document.getElementById("horoscope").innerHTML = rVibe;
        }

        function getImage() {
            // Random number to force refresh
            var rand = Math.floor(Math.random() * 1000);
            document.getElementById("dailyImage").src = "https://loremflickr.com/400/200/nature,calm?lock=" + rand;
        }

        function updateAll() {
            updateClock();
            getWeather();
            getISS();
            getFact();
            getQuote();
            getNews();
            getLocalContent();
            getImage();
        }

        // --- 5. INITIALIZATION ---
        // Run immediately
        updateAll();

        // Intervals
        setInterval(updateClock, 1000);
        setInterval(getISS, 10000);
        setInterval(updateAll, 1800000); // 30 mins
    </script>
</body>
</html>
